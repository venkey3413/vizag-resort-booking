<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events Booking - VShaka Go</title>

  <link rel="icon" type="image/png" href="logo.png" />

  <!-- ‚úÖ Premium Font -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Plus+Jakarta+Sans:wght@700;800;900&display=swap" rel="stylesheet">

  <!-- ‚úÖ Load your premium UI -->
  <link rel="stylesheet" href="premium-ui.css" />

  <style>
    html { scroll-behavior: smooth; }
  </style>
</head>

<body>

  <!-- ‚úÖ PREMIUM NAVBAR -->
  <header class="vrb-navbar">
    <div class="vrb-nav-container">

      <a href="index.html" class="vrb-logo">
        <img src="logo.png" alt="Logo">
        <div class="logo-caption">
          <span>Vizag Starts Here & Go</span>
        </div>
      </a>

      <nav class="vrb-nav-links" id="vrbNavLinks">
      </nav>

      <div class="vrb-nav-actions">
        <a class="vrb-whatsapp" href="https://wa.me/918341674465" target="_blank">WhatsApp</a>
        <a class="vrb-btn-nav" href="index.html#resorts">Book Resort</a>
        <button class="vrb-hamburger" onclick="vrbToggleMenu()">‚ò∞</button>
      </div>
    </div>
  </header>

  <!-- ‚úÖ ICON BUTTONS SECTION -->
  <section class="vrb-icon-buttons">
    <div class="vrb-icon-container">
      <button class="vrb-icon-btn" onclick="window.location.href='events.html'">
        <span class="icon">üéâ</span>
        <span class="text">Events</span>
      </button>
      <button class="vrb-icon-btn" onclick="window.location.href='index.html'">
        <span class="icon">üè®</span>
        <span class="text">Hotel</span>
      </button>
    </div>
  </section>

  <!-- ‚úÖ EVENTS SECTION -->
  <section id="events" class="vrb-section">
    <div class="vrb-container">
      <div class="vrb-section-head vrb-anim">
        <h2 class="vrb-title">Events & Party Bookings in Vizag</h2>
        <p class="vrb-subtitle">
          Birthday ‚Ä¢ Wedding ‚Ä¢ Corporate ‚Ä¢ Engagement ‚Ä¢ Pool Parties
        </p>
      </div>

      <div class="vrb-grid" id="eventsGrid">
        <!-- Events will be loaded dynamically -->
      </div>
    </div>
  </section>

  <!-- ‚úÖ FOOTER -->
  <footer id="contact" class="vrb-footer">
    <div class="vrb-container vrb-footer-grid vrb-anim">

      <div>
        <h3>Vizag Starts Here & Go</h3>
        <p>
          Resorts + Events booking in Vizag.<br>
          Premium verified listings with best deals.
        </p>

        <div class="vrb-footer-badges">
          <span>‚úÖ Verified</span>
          <span>‚ö° Instant Booking</span>
          <span>üí∞ Best Price</span>
        </div>
      </div>

      <div>
        <h4>Quick Links</h4>
        <a href="index.html">Home</a>
        <a href="index.html#resorts">Resorts</a>
        <a href="events.html">Events</a>
      </div>

      <div>
        <h4>Support</h4>
        <a href="tel:+918341674465">üìû +91 8341674465</a>
        <a href="mailto:vizagresortbooking@gmail.com">‚úâÔ∏è vizagresortbooking@gmail.com</a>
        <a href="https://wa.me/918341674465" target="_blank">üí¨ WhatsApp Support</a>
      </div>

    </div>

    <div class="vrb-footer-bottom">
      ¬© 2026 Vizag Starts Here & Go ‚Ä¢ Built with ‚ù§Ô∏è in Vizag
    </div>
  </footer>

  <a class="vrb-policy-btn" href="Cancellation & terms and conditions (1).pdf" target="_blank">
    üìÑ Policy
  </a>

  <!-- ‚úÖ SCRIPTS -->
  <script>
    let events = [];

    function vrbToggleMenu() {
      document.getElementById("vrbNavLinks").classList.toggle("open");
    }

    // Load events from API
    async function loadEvents() {
      try {
        const response = await fetch('/api/events');
        events = await response.json();
        displayEvents();
        console.log('Loaded events:', events.length);
      } catch (error) {
        console.error('Error loading events:', error);
        document.getElementById('eventsGrid').innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Failed to load events. Please refresh the page.</div>';
      }
    }

    function displayEvents() {
      const grid = document.getElementById('eventsGrid');
      if (!grid) return;
      
      if (!events || events.length === 0) {
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No events available at the moment.</div>';
        return;
      }
      
      grid.innerHTML = events.map(event => {
        const amenitiesList = event.amenities ? event.amenities.split('\n').filter(a => a.trim()).slice(0, 4) : [];
        const eventTypeMap = {
          'birthday': 'Birthday Party',
          'wedding': 'Wedding',
          'corporate': 'Corporate Event',
          'engagement': 'Engagement',
          'pool-party': 'Pool Party',
          'anniversary': 'Anniversary'
        };
        const displayName = eventTypeMap[event.event_type] || event.name;
        
        return `
          <div class="vrb-card">
            <div class="vrb-img">
              <img src="${event.image}" alt="${event.name}" onerror="this.src='https://images.unsplash.com/photo-1464366400600-7168b8af9bc3?w=400'">
              <div class="vrb-badge">‚Çπ${event.price.toLocaleString()}</div>
            </div>
            <div class="vrb-body">
              <h3>${displayName}</h3>
              <p class="vrb-meta">üìç ${event.location} ‚Ä¢ üë• ${event.max_guests ? event.max_guests + ' Guests' : 'Flexible'}</p>
              <div class="vrb-tags">
                ${amenitiesList.map(amenity => `<span>${amenity.trim()}</span>`).join('')}
              </div>
              <div class="vrb-bottom">
                <div class="vrb-price">‚Çπ${event.price.toLocaleString()} <span>/event</span></div>
                <button class="vrb-btn-primary" onclick="bookEvent(${event.id})">Book Event</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function bookEvent(eventId) {
      const event = events.find(e => e.id === eventId);
      if (event) {
        openEventBookingModal(eventId, event.name);
      }
    }

    function openEventBookingModal(eventId, eventName) {
      const event = events.find(e => e.id === eventId);
      if (!event) return;
      
      // Create booking modal if it doesn't exist
      let modal = document.getElementById('eventBookingModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'eventBookingModal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:white;padding:2rem;border-radius:10px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;">
            <span onclick="closeEventModal()" style="position:absolute;top:10px;right:15px;font-size:28px;cursor:pointer;color:#999;">&times;</span>
            <h2 id="modalEventName">Book Event</h2>
            <form id="eventBookingForm">
              <input type="hidden" id="eventId">
              <input type="hidden" id="eventPrice">
              
              <div style="margin-bottom:1rem;">
                <label>Full Name:</label>
                <input type="text" id="eventGuestName" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:5px;" required>
              </div>
              
              <div style="margin-bottom:1rem;">
                <label>Email:</label>
                <input type="email" id="eventEmail" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:5px;" required>
              </div>
              
              <div style="margin-bottom:1rem;">
                <label>WhatsApp Number:</label>
                <input type="tel" id="eventPhone" value="+91" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:5px;" required>
              </div>
              
              <div style="margin-bottom:1rem;">
                <label>Event Date:</label>
                <input type="date" id="eventDate" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:5px;" required>
              </div>
              
              <div style="margin-bottom:1rem;">
                <label>Number of Guests:</label>
                <input type="number" id="eventGuests" min="1" value="50" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:5px;" required>
              </div>
              
              <div style="background:#f8f9fa;padding:1rem;border-radius:5px;margin-bottom:1rem;">
                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                  <span>Event Price:</span>
                  <span id="eventBaseAmount">‚Çπ0</span>
                </div>
                <div style="display:flex;justify-content:space-between;font-weight:bold;">
                  <span>Total Amount:</span>
                  <span id="eventTotalAmount">‚Çπ0</span>
                </div>
              </div>
              
              <button type="submit" style="width:100%;background:#007bff;color:white;border:none;padding:1rem;border-radius:5px;cursor:pointer;font-size:1rem;">Book Event</button>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listeners
        document.getElementById('eventBookingForm').addEventListener('submit', handleEventBooking);
        document.getElementById('eventDate').addEventListener('change', calculateEventTotal);
        document.getElementById('eventGuests').addEventListener('change', calculateEventTotal);
      }
      
      // Populate modal with event data
      document.getElementById('eventId').value = eventId;
      document.getElementById('eventPrice').value = event.price;
      document.getElementById('modalEventName').textContent = `Book ${eventName}`;
      
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('eventDate').min = today;
      document.getElementById('eventDate').value = today;
      
      calculateEventTotal();
      modal.style.display = 'flex';
    }

    function closeEventModal() {
      const modal = document.getElementById('eventBookingModal');
      if (modal) {
        modal.style.display = 'none';
        document.getElementById('eventBookingForm').reset();
      }
    }

    function calculateEventTotal() {
      const eventPrice = parseInt(document.getElementById('eventPrice').value) || 0;
      const baseAmount = eventPrice;
      const totalAmount = baseAmount;
      
      document.getElementById('eventBaseAmount').textContent = `‚Çπ${baseAmount.toLocaleString()}`;
      document.getElementById('eventTotalAmount').textContent = `‚Çπ${totalAmount.toLocaleString()}`;
    }

    async function handleEventBooking(e) {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Processing...';
      submitBtn.disabled = true;

      const bookingData = {
        eventId: document.getElementById('eventId').value,
        guestName: document.getElementById('eventGuestName').value,
        email: document.getElementById('eventEmail').value,
        phone: document.getElementById('eventPhone').value,
        eventDate: document.getElementById('eventDate').value,
        guests: document.getElementById('eventGuests').value
      };
      
      // Basic validation
      if (!bookingData.eventId || !bookingData.guestName || !bookingData.email || !bookingData.phone || !bookingData.eventDate) {
        alert('Please fill all required fields');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
      }
      
      // Phone validation
      if (!bookingData.phone.match(/^\+91[0-9]{10}$/)) {
        alert('Please enter a valid Indian WhatsApp number (+91 followed by 10 digits)');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
      }
      
      try {
        const event = events.find(e => e.id == bookingData.eventId);
        if (!event) {
          alert('Event not found');
          return;
        }
        
        const totalPrice = event.price;
        const bookingReference = `EV${String(Date.now()).slice(-6)}`;
        
        // Create booking data for payment
        const eventBookingData = {
          ...bookingData,
          eventName: event.name,
          totalPrice: totalPrice,
          bookingReference: bookingReference
        };
        
        showEventPaymentInterface(eventBookingData);
        closeEventModal();
      } catch (error) {
        console.error('Event booking error:', error);
        alert('Booking failed. Please try again.');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    function showEventPaymentInterface(booking) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `
        <div style="background:white;padding:2rem;border-radius:10px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;">
          <h2>üí≥ Complete Payment</h2>
          <div style="background:#f8f9fa;padding:1rem;border-radius:5px;margin-bottom:1rem;">
            <h3>${booking.eventName}</h3>
            <p><strong>Booking ID:</strong> ${booking.bookingReference}</p>
            <p><strong>Guest:</strong> ${booking.guestName}</p>
            <p><strong>Event Date:</strong> ${new Date(booking.eventDate).toLocaleDateString()}</p>
            <p><strong>Guests:</strong> ${booking.guests}</p>
            <p><strong>Total Amount:</strong> ‚Çπ${booking.totalPrice.toLocaleString()}</p>
          </div>
          
          <div style="margin-bottom:1rem;">
            <h4>Pay via UPI</h4>
            <div style="background:#e8f5e8;padding:1rem;border-radius:5px;margin-bottom:1rem;">
              <p><strong>UPI ID:</strong> venkatesh3413@paytm</p>
              <p><strong>Amount:</strong> ‚Çπ${booking.totalPrice.toLocaleString()}</p>
              <p><strong>Note:</strong> ${booking.bookingReference} - ${booking.guestName}</p>
            </div>
            
            <div style="text-align:center;margin-bottom:1rem;">
              <img src="qr-code.png.jpeg" alt="UPI QR Code" style="max-width:200px;border-radius:8px;">
              <p>Scan QR code or use UPI ID above</p>
            </div>
            
            <div>
              <label>Enter Transaction ID (UTR):</label>
              <input type="text" id="eventTransactionId" placeholder="Enter 12-digit UTR ID" maxlength="12" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:5px;margin-bottom:1rem;">
              <button onclick="confirmEventPayment('${booking.bookingReference}', ${booking.totalPrice})" style="width:100%;background:#28a745;color:white;border:none;padding:1rem;border-radius:5px;cursor:pointer;font-size:1rem;">
                ‚úÖ Confirm Payment
              </button>
            </div>
          </div>
          
          <button onclick="closeEventPaymentModal()" style="width:100%;background:#6c757d;color:white;border:none;padding:0.5rem;border-radius:5px;cursor:pointer;">Cancel</button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Store booking data globally
      window.currentEventBooking = booking;
    }

    function closeEventPaymentModal() {
      const modal = document.querySelector('div[style*="z-index:10001"]');
      if (modal) {
        modal.remove();
      }
    }

    async function confirmEventPayment(bookingReference, amount) {
      const transactionId = document.getElementById('eventTransactionId').value.trim();
      
      if (!transactionId) {
        alert('Please enter the transaction ID (UTR)');
        return;
      }
      
      if (transactionId.length < 8) {
        alert('Please enter a valid transaction ID (minimum 8 characters)');
        return;
      }
      
      try {
        // Send event booking to server for Telegram notification
        const booking = window.currentEventBooking;
        await fetch('/api/event-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookingReference: bookingReference,
            eventName: booking.eventName,
            guestName: booking.guestName,
            email: booking.email,
            phone: booking.phone,
            eventDate: booking.eventDate,
            guests: booking.guests,
            totalPrice: amount,
            transactionId: transactionId
          })
        });
        
        alert(`Event booking confirmed! Booking ID: ${bookingReference}. You will receive confirmation via email and WhatsApp.`);
        closeEventPaymentModal();
        
        // Send WhatsApp message
        const message = `Event Booking Confirmed!\n\nBooking ID: ${bookingReference}\nEvent: ${booking.eventName}\nDate: ${new Date(booking.eventDate).toLocaleDateString()}\nGuests: ${booking.guests}\nAmount: ‚Çπ${amount.toLocaleString()}\nTransaction ID: ${transactionId}`;
        const whatsappUrl = `https://wa.me/918341674465?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      } catch (error) {
        alert('Payment confirmation failed. Please contact support.');
      }
    }

    // Setup Redis real-time updates
    function setupRedisSync() {
      console.log('üì° Redis real-time sync enabled for events page');
      
      let eventSource;
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5;
      
      function connectEventSource() {
        try {
          eventSource = new EventSource('/api/events-stream');
          
          eventSource.onmessage = function(event) {
            try {
              const data = JSON.parse(event.data);
              console.log('üì° Events page Redis event received:', data);
              
              if (data.type === 'event.updated' || data.type === 'event.created' || data.type === 'event.deleted') {
                console.log('üéâ Event update received - refreshing events');
                loadEvents();
              }
            } catch (error) {
              // Ignore ping messages
            }
          };
          
          eventSource.onerror = function(error) {
            console.log('‚ö†Ô∏è Events page Redis connection error, attempting reconnect...');
            eventSource.close();
            
            if (reconnectAttempts < maxReconnectAttempts) {
              reconnectAttempts++;
              setTimeout(connectEventSource, 2000 * reconnectAttempts);
            } else {
              console.log('‚ùå Max reconnection attempts reached');
            }
          };
          
          eventSource.onopen = function() {
            console.log('‚úÖ Redis connected to events page');
            reconnectAttempts = 0;
          };
        } catch (error) {
          console.error('Events page Redis setup failed:', error);
        }
      }
      
      connectEventSource();
    }

    // Enhanced Animation System
    document.addEventListener('DOMContentLoaded', function() {
      // Load events on page load
      loadEvents();
      
      // Setup Redis sync after a delay
      setTimeout(setupRedisSync, 1000);
      
      // Scroll animations
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('animate');
          }
        });
      }, observerOptions);

      // Observe all animation elements
      document.querySelectorAll('.vrb-anim').forEach(el => {
        observer.observe(el);
      });

      // Button click animations
      document.querySelectorAll('button, .vrb-btn, .vrb-btn-primary').forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.add('bounce-on-click');
          setTimeout(() => {
            this.classList.remove('bounce-on-click');
          }, 600);
        });
      });
    });
  </script>

</body>
</html>